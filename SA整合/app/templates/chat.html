<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>聊天室</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='chat.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='main.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link
      rel="icon"
      href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSBCQvRUMCVLV0tQ-FTN0ozYD46foS6NsF8Ow&s"
    />
    <script>
      async function sendMessage() {
        const questionInput = document.getElementById("question");
        const question = questionInput.value.trim();
        const chatBox = document.querySelector(".chat-box");
        const loadingSpinner = document.getElementById("loading-spinner"); // 指向固定的 loading spinner 元素

        if (!question) {
          // 使用 innerHTML 添加訊息
          chatBox.innerHTML += `<div class="message bot">請輸入問題！</div>`;
          chatBox.scrollTop = chatBox.scrollHeight;
          return;
        }

        chatBox.innerHTML += `<div class="message user">${question}</div>`;
        questionInput.value = "";
        if (loadingSpinner) loadingSpinner.style.display = "inline-block"; // 顯示 loading (inline-block 以便和按鈕同行)
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
          const response = await fetch("/ask", {
            // API 端點以 chat.html 為主
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ question }),
          });

          const data = await response.json();
          if (loadingSpinner) loadingSpinner.style.display = "none"; // 隱藏 loading

          let botResponseText = "";
          if (response.ok) {
            // 假設 Gemini 的回應可能包含 HTML，也可能包含 **
            // 如果 chat.html 的後端 /ask 已經處理了 HTML，這裡就不需要 .replace(/\*\*/g, "")
            // 但如果 Gemini 直接輸出 Markdown 的 **，就需要保留
            botResponseText = data.response.replace(/\*\*/g, ""); // 清除 **
          } else {
            botResponseText =
              data.error || data.response || "發生錯誤，請稍後再試。";
          }
          chatBox.innerHTML += `<div class="message bot">${botResponseText}</div>`; // 使用 innerHTML
          chatBox.scrollTop = chatBox.scrollHeight;
        } catch (err) {
          console.error("Error fetching response:", err);
          if (loadingSpinner) loadingSpinner.style.display = "none";
          chatBox.innerHTML += `<div class="message bot">連線錯誤，請稍後再試。</div>`;
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      }

      function clearHistory() {
        fetch("/clear_history", {
          // API 端點以 chat.html 為主
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data.message);
            const chatBox = document.querySelector(".chat-box");
            chatBox.innerHTML = "";
            loadSuggestions(); // 清空後重新加載建議
            // 可選: 重新顯示初始標題
            if (!document.getElementById("animated-title")) {
              const initialTitle = document.createElement("div");
              initialTitle.id = "animated-title"; // 與 chat.html 的 ID 一致
              initialTitle.innerText = "歡迎來到聊天室"; // 與 chat.html 的文字一致
              chatBox.insertBefore(initialTitle, chatBox.firstChild);
              setTimeout(() => {
                if (initialTitle) initialTitle.remove();
              }, 15000);
            }
          })
          .catch((error) => console.error("Error clearing history:", error));
      }

      async function loadSuggestions() {
        try {
          // 假設建議問題的 API 路徑 (以 chat.html 風格)
          const res = await fetch("/random_questions");
          if (!res.ok) {
            console.error("Failed to load suggestions:", res.status);
            const list = document.getElementById("suggestion-list");
            if (list) list.innerHTML = "<li>無法載入建議問題</li>";
            return;
          }
          const questions = await res.json();
          const list = document.getElementById("suggestion-list");
          if (!list) return;

          list.innerHTML = "";

          questions.forEach((q) => {
            const btn = document.createElement("button");
            btn.innerText = q;
            // 樣式已在 <style> 標籤中定義
            btn.onclick = () => {
              document.getElementById("question").value = q;
              sendMessage(); // 自動發送
            };
            list.appendChild(btn);
          });
        } catch (err) {
          console.error("Error loading suggestions:", err);
          const list = document.getElementById("suggestion-list");
          if (list) list.innerHTML = "<li>載入建議問題時發生錯誤</li>";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const menuToggle = document.getElementById("menu-toggle");
        const sidebar = document.getElementById("sidebar");
        const closeSidebar = document.getElementById("close-sidebar");
        const animatedTitle = document.getElementById("animated-title"); // 使用 chat.html 的 ID

        if (menuToggle && sidebar && closeSidebar) {
          menuToggle.addEventListener("click", () =>
            sidebar.classList.add("active")
          );
          closeSidebar.addEventListener("click", () =>
            sidebar.classList.remove("active")
          );
        }

        if (animatedTitle) {
          setTimeout(() => animatedTitle.remove(), 15000);
        }

        loadSuggestions(); // 頁面載入時獲取建議問題
      });

      function openFeedbackModal() {
        const modal = document.getElementById("feedback-modal");
        if (modal) modal.style.display = "block";
      }

      function closeFeedbackModal() {
        const modal = document.getElementById("feedback-modal");
        if (modal) modal.style.display = "none";
      }

      async function submitFeedback() {
        const satisfied = document.querySelector(
          'input[name="satisfied"]:checked'
        );
        const feedbackText = document.getElementById("feedback-text").value;

        if (!satisfied) {
          alert("請選擇是否解決您的問題！");
          return;
        }

        let lastUserQuestion = "N/A";
        let lastBotAnswer = "N/A";
        const messages = document.querySelectorAll(".chat-box .message");
        // 嘗試從後往前找到最後一組 user 和 bot 的對話
        for (let i = messages.length - 1; i >= 0; i--) {
          if (messages[i].classList.contains("bot")) {
            lastBotAnswer = messages[i].innerText; // 或 innerHTML 如果需要包含HTML標籤
            // 找到 bot 回答後，往前找最近的 user 問題
            if (i > 0 && messages[i - 1].classList.contains("user")) {
              lastUserQuestion = messages[i - 1].innerText;
            }
            break; // 找到最後一個 bot 回答即可
          }
        }
        // 如果最後一條是使用者訊息，但沒有bot回應，則抓取最後一條使用者訊息
        if (
          lastBotAnswer === "N/A" &&
          messages.length > 0 &&
          messages[messages.length - 1].classList.contains("user")
        ) {
          lastUserQuestion = messages[messages.length - 1].innerText;
        }

        const response = await fetch("/feedback", {
          // API 端點以 chat.html 為主
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            question: lastUserQuestion,
            answer: lastBotAnswer,
            solved: satisfied.value,
            suggestion: feedbackText,
          }),
        });

        if (response.ok) {
          alert("感謝您的回饋！");
          closeFeedbackModal();
        } else {
          alert("送出失敗，請稍後再試。");
        }
      }
    </script>
  </head>
  <body>
    <div class="chat-wrapper">
      <nav class="nav-bar">
        <button id="menu-toggle">
          <i class="bi bi-border-width"></i>
        </button>
        <div id="sidebar">
          <button id="close-sidebar"><i class="bi bi-x-lg"></i></button>
          <h2>選單</h2>
          <hr class="menu-divider" />
          <a href="/update_profile"
            ><i class="fa-solid fa-house"></i> 個人資料</a
          >
          <a href="/post"><i class="fa-solid fa-house"></i> 我的貼文</a>
          <a href="/announcements"><i class="fa-solid fa-house"></i>所有公告</a>
        </div>
        <a href="#">
          <svg
            width="64"
            height="64"
            viewBox="0 0 200 200"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M40 60 L160 60 L140 100 C130 110, 110 110, 100 100 C90 90, 70 90, 60 100 Z"
              stroke="#1e3a5f"
              stroke-width="2"
              fill="none"
            />
          </svg>
        </a>
        <span>輔大資管系</span>
        <div class="nav-link">
          <i class="bi bi-house-door"></i><a href="#">首頁</a>

          {% if session.get('user') %}
          <i class="bi bi-megaphone"></i><a href="/post/interact">交流區</a>
          <i class="bi bi-chat-dots"></i><a href="/chatroom">聊天室</a>
          {% if session.get('role') == 'M' or session.get('role') == 'm' %}
          <div class="admin-dropdown">
            <i class="bi bi-gear"></i>
            <span>管理者功能</span>
            <div class="dropdown-menu">
              <a href="/post/admin/warning_post"
                ><i class="bi bi-exclamation-triangle"></i>預警貼文</a
              >
              <a href="/post/admin/flagged_posts"
                ><i class="bi bi-clipboard-check"></i>貼文審核</a
              >
              <a href="/post/admin/category_overview"
                ><i class="bi bi-eye"></i>貼文預覽</a
              >
              <a href="/post/admin/faq_question"
                ><i class="bi bi-question-circle"></i>問題追蹤</a
              >
            </div>
          </div>
          {% endif %}
          <i class="bi bi-box-arrow-right"></i><a href="/logout">登出</a>

          <div class="user-info">
            <div class="avatar-dropdown">
              <div class="avatar-info">
                <img
                  id="userImage"
                  src="{{ url_for('static', filename=avatar.split('static/')[1]) }}"
                  alt="使用者頭像"
                  class="rounded-full"
                />
                <span class="hidden md:inline">{{ name }}</span>
                <i class="bi bi-person-fill"></i>
              </div>
              <!-- <div class="dropdown-menu">
                  <a href="/information">編輯個人資料</a>
                  <a href="/profile">更改頭像</a>
                </div> -->
            </div>
          </div>

          {% else %}
          <i class="bi bi-box-arrow-in-right"></i><a href="/">登入</a>
          {% endif %}
        </div>
      </nav>

      <aside id="sidebar">
        <button id="close-sidebar">&times;</button>
        <a href="#">選項一</a>
        <hr class="menu-divider" />
        <a href="#">選項二</a>
        <hr class="menu-divider" />
        <a href="#">選項三</a>
      </aside>

      <div
        id="suggestion-box"
        style="
          padding: 10px 15px;
          border-bottom: 1px solid #eee;
          background: #f9f9f9;
        "
      >
        <strong>你可以問我：</strong>
        <div
          id="suggestion-list"
          style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px"
        ></div>
      </div>

      <div class="chat-box">
        <div id="animated-title">歡迎來到聊天室</div>
      </div>


      <div
          id="loading-spinner"
          class="loading-spinner"
          style="display: none"
        ></div>
      <div id="input-area">
        <input type="text" id="question" placeholder="請輸入您的問題" />
        
        <button
          type="button"
          onclick="openFeedbackModal()"
          class="feedback-btn"
        >
          回饋
        </button>
        <button class="sent" onclick="sendMessage()">
          <i class="bi bi-send"></i> 送出
        </button>
        <button class="clear-btn" onclick="clearHistory()">
          <i class="bi bi-x-square"></i> 清除
        </button>
      </div>
    </div>

    <div id="feedback-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeFeedbackModal()">&times;</span>
        <h2>這個回答是否有解決您的問題？</h2>
        <label> <input type="radio" name="satisfied" value="yes" /> 是 </label>
        <label> <input type="radio" name="satisfied" value="no" /> 否 </label>
        <h3 style="margin-top: 15px; margin-bottom: 5px">
          請問有什麼建議可以讓我們改善？
        </h3>
        <textarea
          id="feedback-text"
          rows="4"
          style="width: 95%"
          placeholder="請輸入您的建議..."
        ></textarea>
        <button onclick="submitFeedback()" style="margin-top: 15px">
          送出回饋
        </button>
      </div>
    </div>
  </body>
</html>
